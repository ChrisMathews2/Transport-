<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AT Organizational Design Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: #f5f6fa; 
            color: #2c3e50;
            overflow-x: hidden;
        }
        
        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #1e293b;
            color: white;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }
        
        .sidebar.collapsed {
            width: 60px;
        }
        
        .logo {
            padding: 20px;
            font-size: 20px;
            font-weight: 700;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.2s;
            gap: 12px;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }
        
        .nav-item:hover {
            background: #334155;
            color: white;
        }
        
        .nav-item.active {
            background: #3b82f6;
            color: white;
        }
        
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
        }
        
        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-primary.edit-active {
            background: #1e3a8a;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        /* Toolbar */
        .toolbar {
            background: white;
            padding: 12px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .toolbar-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: #e5e7eb;
        }
        
        /* View Container */
        .view-container {
            flex: 1;
            padding: 24px;
            overflow: auto;
            background: #f5f6fa;
        }
        
        /* Org Chart Styles */
        .org-chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            min-height: 600px;
            position: relative;
            overflow: auto;
            transition: transform 0.3s ease;
        }
        
        .org-chart-wrapper {
            transform-origin: center center;
            transition: transform 0.3s ease;
            position: relative;
            min-width: 100%;
            min-height: 100%;
        }
        
        .org-node {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            min-width: 200px;
            cursor: move;
            transition: all 0.2s;
            position: relative;
            margin: 10px;
        }
        
        .org-node:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .org-node.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .org-node.dragging {
            opacity: 0.5;
        }
        
        .org-node.division-cnp { border-left: 4px solid #3b82f6; }
        .org-node.division-ip { border-left: 4px solid #10b981; }
        .org-node.division-fcs { border-left: 4px solid #f59e0b; }
        .org-node.division-pt { border-left: 4px solid #8b5cf6; }
        .org-node.division-partnerships { border-left: 4px solid #ef4444; }
        .org-node.division-people { border-left: 4px solid #ec4899; }
        .org-node.division-strategy { border-left: 4px solid #6b7280; }
        
        .node-title {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
            margin-bottom: 4px;
        }
        
        .node-subtitle {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .node-metrics {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #4b5563;
        }
        
        .node-metric {
            display: flex;
            flex-direction: column;
        }
        
        .metric-value {
            font-weight: 600;
            color: #1e293b;
        }
        
        /* Hierarchy Levels */
        .hierarchy-container {
            display: flex;
            flex-direction: column;
            gap: 60px;
            align-items: center;
            padding: 40px;
        }
        
        .hierarchy-level {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            position: relative;
        }
        
        .level-label {
            position: absolute;
            left: -80px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        /* Connection Lines */
        svg.connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .connection-line {
            stroke: #e5e7eb;
            stroke-width: 2;
            fill: none;
        }
        
        /* Analytics Panel */
        .analytics-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .metric-card h3 {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .metric-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
        }
        
        .metric-card .change {
            font-size: 12px;
            margin-top: 4px;
        }
        
        .change.positive {
            color: #10b981;
        }
        
        .change.negative {
            color: #ef4444;
        }
        
        /* Scenario Comparison */
        .scenario-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .scenario-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .scenario-tab {
            padding: 8px 16px;
            border: none;
            background: none;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .scenario-tab:hover {
            color: #4b5563;
        }
        
        .scenario-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        /* Enhanced Scenario Styles */
        .scenario-view-content {
            display: block;
        }
        
        .scenario-details-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .scenario-details-card h3 {
            padding: 20px 25px;
            margin: 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 18px;
            color: #1f2937;
        }
        
        .scenario-summary-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .summary-card {
            padding: 25px;
            text-align: center;
            border-right: 1px solid #e5e7eb;
            position: relative;
        }
        
        .summary-card:last-child {
            border-right: none;
        }
        
        .summary-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .summary-value {
            font-size: 36px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .summary-percent {
            font-size: 14px;
            color: #9ca3af;
        }
        
        .scenario-tag {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .scenario-tag:hover {
            background: #374151;
        }
        
        .function-table-container {
            padding: 0 25px 25px;
        }
        
        .scenario-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .scenario-table th {
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .scenario-table td {
            padding: 16px 0;
            font-size: 14px;
            color: #1f2937;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .scenario-table tr:last-child td {
            border-bottom: none;
        }
        
        .scenario-table th:not(:first-child),
        .scenario-table td:not(:first-child) {
            text-align: center;
        }
        
        .scenario-table tfoot tr {
            font-weight: bold;
            border-top: 2px solid #e5e7eb;
        }
        
        .editable-cell {
            position: relative;
        }
        
        .allocation-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
            background: white;
            transition: all 0.2s;
        }
        
        .allocation-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .edit-mode .scenario-table tr:hover {
            background: #f9fafb;
        }
        
        .filter-controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }
        
        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .cost-value {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
        }
        
        .savings-positive {
            color: #10b981;
        }
        
        .total-changed {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .percent-changed {
            font-weight: 600;
        }
        
        /* Properties Panel */
        .properties-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 320px;
            height: 100vh;
            background: white;
            border-left: 1px solid #e5e7eb;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .properties-panel.open {
            transform: translateX(0);
        }
        
        .properties-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .properties-content {
            padding: 20px;
        }
        
        .property-group {
            margin-bottom: 24px;
        }
        
        .property-group h4 {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
        }
        
        .property-field {
            margin-bottom: 16px;
        }
        
        .property-field label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .property-field input,
        .property-field select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }
        
        /* Charts Container */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .chart-card h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.open {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }
        
        /* Workforce Planning Grid */
        .workforce-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 16px;
        }
        
        .workforce-cell {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        
        .workforce-cell .label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .workforce-cell .value {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }
        
        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            color: #6b7280;
        }
        
        /* Dropdown Menu */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            display: none;
            z-index: 100;
        }
        
        .dropdown.open .dropdown-menu {
            display: block;
        }
        
        .dropdown-item {
            padding: 8px 16px;
            display: block;
            color: #4b5563;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }
        
        .dropdown-item:hover {
            background: #f3f4f6;
            color: #1e293b;
        }
        
        .dropdown-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 4px 0;
        }
        
        /* Skills Matrix */
        .skills-matrix {
            background: white;
            border-radius: 12px;
            padding: 24px;
            overflow-x: auto;
        }
        
        .skills-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .skills-table th,
        .skills-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .skills-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }
        
        .skill-level {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 4px;
        }
        
        .skill-level.expert { background: #10b981; }
        .skill-level.proficient { background: #3b82f6; }
        .skill-level.competent { background: #f59e0b; }
        .skill-level.developing { background: #6b7280; }
        .skill-level.none { background: #e5e7eb; }
        
        /* Hide elements during certain states */
        .edit-mode .level-label { display: none; }
        .edit-mode .connection-line { opacity: 0.3; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <span>üè¢</span>
                <span class="logo-text">AT OrgDesign</span>
            </div>
            <nav class="nav-menu">
                <button class="nav-item active" onclick="showView(this, 'orgchart')">
                    <span class="nav-icon">üìä</span>
                    <span>Org Chart</span>
                </button>
                <button class="nav-item" onclick="showView(this, 'scenarios')">
                    <span class="nav-icon">üîÑ</span>
                    <span>Scenarios</span>
                </button>
                <button class="nav-item" onclick="showView(this, 'analytics')">
                    <span class="nav-icon">üìà</span>
                    <span>Analytics</span>
                </button>
                <button class="nav-item" onclick="showView(this, 'workforce')">
                    <span class="nav-icon">üë•</span>
                    <span>Workforce Planning</span>
                </button>
                <button class="nav-item" onclick="showView(this, 'cost')">
                    <span class="nav-icon">üí∞</span>
                    <span>Cost Modeling</span>
                </button>
                <button class="nav-item" onclick="showView(this, 'skills')">
                    <span class="nav-icon">üéØ</span>
                    <span>Skills Matrix</span>
                </button>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 class="header-title" id="viewTitle">Organizational Chart</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="toggleScenarioMode()">
                        <span id="scenarioModeText">View Mode</span>
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-primary" onclick="toggleDropdown(this)">
                            Actions ‚ñº
                        </button>
                        <div class="dropdown-menu">
                            <button class="dropdown-item" onclick="saveScenario()">Save Scenario</button>
                            <button class="dropdown-item" onclick="exportData()">Export Data</button>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" onclick="showImportModal()">Import Structure</button>
                            <button class="dropdown-item" onclick="resetToBaseline()">Reset to Baseline</button>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Toolbar -->
            <div class="toolbar" id="toolbar">
                <div class="toolbar-group">
                    <button class="btn btn-secondary" onclick="zoomIn()">‚ûï Zoom In</button>
                    <button class="btn btn-secondary" onclick="zoomOut()">‚ûñ Zoom Out</button>
                    <button class="btn btn-secondary" onclick="fitToScreen()">‚¨ú Fit</button>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <label style="font-size: 14px; margin-right: 8px;">View:</label>
                    <select id="viewLevel" onchange="updateOrgView()" style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        <option value="all">All Levels</option>
                        <option value="1">CEO + 1</option>
                        <option value="2">CEO + 2</option>
                        <option value="3">CEO + 3</option>
                    </select>
                </div>
                <div class="toolbar-divider"></div>
                <div class="toolbar-group">
                    <label style="font-size: 14px; margin-right: 8px;">Color by:</label>
                    <select id="colorBy" onchange="updateNodeColors()" style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
                        <option value="division">Division</option>
                        <option value="fillRate">Fill Rate</option>
                        <option value="spanOfControl">Span of Control</option>
                        <option value="cost">Cost</option>
                    </select>
                </div>
            </div>
            
            <!-- View Container -->
            <div class="view-container">
                <!-- Org Chart View -->
                <div id="orgchart-view" class="view-content">
                    <div class="analytics-panel" id="orgMetricsPanel">
                        <div class="metric-card">
                            <h3>Total Headcount</h3>
                            <div class="value" id="totalHeadcount">2,300</div>
                            <div class="change positive">+3.2% from baseline</div>
                        </div>
                        <div class="metric-card">
                            <h3>Total FTE</h3>
                            <div class="value" id="totalFTE">1,904</div>
                            <div class="change negative">-1.5% from baseline</div>
                        </div>
                        <div class="metric-card">
                            <h3>Avg Span of Control</h3>
                            <div class="value" id="avgSpan">5.8</div>
                            <div class="change">Optimal: 6-8</div>
                        </div>
                        <div class="metric-card">
                            <h3>Organizational Layers</h3>
                            <div class="value" id="orgLayers">6</div>
                            <div class="change">Industry avg: 7</div>
                        </div>
                    </div>
                    
                    <div class="org-chart-container" id="orgChart">
                        <div class="org-chart-wrapper" id="orgChartWrapper">
                            <svg class="connections" id="connectionsSvg"></svg>
                            <div class="hierarchy-container" id="hierarchyContainer">
                                <!-- Dynamic content will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Scenarios View -->
                <div id="scenarios-view" class="view-content" style="display: none;">
                    <div class="scenario-panel">
                        <div class="scenario-tabs">
                            <button class="scenario-tab active" onclick="selectScenario(this, 'baseline')">Baseline</button>
                            <button class="scenario-tab" onclick="selectScenario(this, 'integration')">AC Integration</button>
                            <button class="scenario-tab" onclick="selectScenario(this, 'optimization')">Optimization</button>
                            <button class="scenario-tab" onclick="selectScenario(this, 'growth')">Growth 2027</button>
                            <button class="btn btn-primary" style="margin-left: auto;" onclick="createNewScenario()">+ New Scenario</button>
                        </div>
                    </div>
                    
                    <!-- Scenario Controls -->
                    <div class="filter-controls" style="margin-bottom: 20px;">
                        <div class="filter-row" style="align-items: center;">
                            <div class="filter-group" style="flex: 1;">
                                <label>Scenario View</label>
                                <select id="scenarioViewType" onchange="updateScenarioViewType()">
                                    <option value="overview">Overview</option>
                                    <option value="allocation">Staff Allocation</option>
                                    <option value="financial">Financial Impact</option>
                                </select>
                            </div>
                            <div class="filter-group" style="flex: 0;">
                                <button class="btn btn-primary" id="allocationModeBtn" onclick="toggleAllocationMode()" style="display: none;">Policy Mode</button>
                                <button class="btn btn-secondary" id="resetAllocationBtn" onclick="resetAllocations()" style="display: none; margin-left: 10px;">Reset</button>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #6b7280; margin-top: 10px; display: none;" id="allocationHint">
                            üí° In edit mode: Adjust staff allocations between divisions. Total headcount updates automatically.
                        </p>
                    </div>
                    
                    <!-- Overview View -->
                    <div id="scenario-overview" class="scenario-view-content">
                        <div class="analytics-panel">
                            <div class="metric-card">
                                <h3>Scenario Impact</h3>
                                <div class="value" id="scenarioImpact">-$3.2M</div>
                                <div class="change positive">Annual savings</div>
                            </div>
                            <div class="metric-card">
                                <h3>FTE Change</h3>
                                <div class="value" id="fteChange">-156</div>
                                <div class="change negative">-8.2% reduction</div>
                            </div>
                            <div class="metric-card">
                                <h3>Affected Staff</h3>
                                <div class="value" id="affectedStaff">487</div>
                                <div class="change">Requiring transition</div>
                            </div>
                            <div class="metric-card">
                                <h3>Implementation</h3>
                                <div class="value">18 mo</div>
                                <div class="change">Estimated timeline</div>
                            </div>
                        </div>
                        
                        <div class="charts-grid">
                            <div class="chart-card">
                                <h3>Scenario Comparison</h3>
                                <div class="chart-wrapper">
                                    <canvas id="scenarioComparisonChart"></canvas>
                                </div>
                            </div>
                            <div class="chart-card">
                                <h3>Cost Impact Over Time</h3>
                                <div class="chart-wrapper">
                                    <canvas id="costImpactChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Staff Allocation View -->
                    <div id="scenario-allocation" class="scenario-view-content" style="display: none;">
                        <div class="scenario-details-card">
                            <h3>Staff Movement Analysis</h3>
                            
                            <div class="scenario-summary-cards">
                                <div class="summary-card">
                                    <div class="summary-label">TOTAL POSITIONS</div>
                                    <div class="summary-value" id="totalPositions">1,804</div>
                                    <button class="scenario-tag" id="allocationScenarioTag">Policy</button>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-label">INTERNAL REORG</div>
                                    <div class="summary-value" id="internalReorg">1,332</div>
                                    <div class="summary-percent" id="percentInternal">73.8%</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-label">EXTERNAL TRANSFER</div>
                                    <div class="summary-value" id="externalTransfer">472</div>
                                    <div class="summary-percent" id="percentExternal">26.2%</div>
                                </div>
                            </div>
                            
                            <div class="function-table-container">
                                <table class="scenario-table">
                                    <thead>
                                        <tr>
                                            <th>DIVISION</th>
                                            <th>CURRENT STAFF</th>
                                            <th>INTERNAL REORG</th>
                                            <th>EXTERNAL TRANSFER</th>
                                            <th>% EXTERNAL</th>
                                        </tr>
                                    </thead>
                                    <tbody id="allocationTableBody">
                                        <!-- Dynamic content -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td>TOTAL</td>
                                            <td id="footerTotalCurrent">1,804</td>
                                            <td id="footerTotalInternal">1,332</td>
                                            <td id="footerTotalExternal">472</td>
                                            <td id="footerPercentExternal">26.2%</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h3>Staff Reallocation by Division</h3>
                            <div class="chart-wrapper">
                                <canvas id="staffAllocationChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Financial Impact View -->
                    <div id="scenario-financial" class="scenario-view-content" style="display: none;">
                        <div class="scenario-details-card">
                            <h3>Financial Impact Analysis</h3>
                            
                            <div class="scenario-summary-cards">
                                <div class="summary-card">
                                    <div class="summary-label">ANNUAL SAVINGS</div>
                                    <div class="summary-value" id="annualSavings">$20M</div>
                                    <div class="summary-percent">11.1% reduction</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-label">TRANSITION COST</div>
                                    <div class="summary-value" id="transitionCost">$10M</div>
                                    <div class="summary-percent" id="roiPercent">200% ROI</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-label">PAYBACK PERIOD</div>
                                    <div class="summary-value" id="paybackPeriod">6</div>
                                    <div class="summary-percent">months</div>
                                </div>
                            </div>
                            
                            <div class="function-table-container">
                                <table class="scenario-table">
                                    <thead>
                                        <tr>
                                            <th>COST CATEGORY</th>
                                            <th>CURRENT COST</th>
                                            <th>PROJECTED COST</th>
                                            <th>ANNUAL SAVINGS</th>
                                            <th>SAVINGS %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="financialTableBody">
                                        <!-- Dynamic content -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td>TOTAL</td>
                                            <td id="financialTotalCurrent">$180.0M</td>
                                            <td id="financialTotalProjected">$160.0M</td>
                                            <td id="financialTotalSavings">$20.0M</td>
                                            <td id="financialTotalPercent">11.1%</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        
                        <div class="charts-grid">
                            <div class="chart-card">
                                <h3>Savings by Category</h3>
                                <div class="chart-wrapper">
                                    <canvas id="savingsCategoryChart"></canvas>
                                </div>
                            </div>
                            <div class="chart-card">
                                <h3>Cost Efficiency Metrics</h3>
                                <div class="impact-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 20px;">
                                    <div class="impact-card" style="background: #f9fafb; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div class="impact-label" style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Cost per FTE</div>
                                        <div class="impact-value" style="font-size: 24px; font-weight: 600; color: #1f2937;" id="costPerFTE">$88.8k</div>
                                    </div>
                                    <div class="impact-card" style="background: #f9fafb; padding: 15px; border-radius: 8px; text-align: center;">
                                        <div class="impact-label" style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Efficiency Gain</div>
                                        <div class="impact-value" style="font-size: 24px; font-weight: 600; color: #1f2937;" id="efficiencyGain">11.1%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics View -->
                <div id="analytics-view" class="view-content" style="display: none;">
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>Span of Control Distribution</h3>
                            <div class="chart-wrapper">
                                <canvas id="spanControlChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Organization Layers Analysis</h3>
                            <div class="chart-wrapper">
                                <canvas id="layersChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Cost per FTE by Division</h3>
                            <div class="chart-wrapper">
                                <canvas id="costPerFTEChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Fill Rate Trends</h3>
                            <div class="chart-wrapper">
                                <canvas id="fillRateChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Workforce Planning View -->
                <div id="workforce-view" class="view-content" style="display: none;">
                    <div class="scenario-panel">
                        <h3>Workforce Capacity Planning</h3>
                        <div class="workforce-grid">
                            <div class="workforce-cell">
                                <div class="label">Current HC</div>
                                <div class="value">2,113</div>
                            </div>
                            <div class="workforce-cell">
                                <div class="label">Projected HC</div>
                                <div class="value">2,250</div>
                            </div>
                            <div class="workforce-cell">
                                <div class="label">Gap</div>
                                <div class="value" style="color: #ef4444;">-137</div>
                            </div>
                            <div class="workforce-cell">
                                <div class="label">Attrition Rate</div>
                                <div class="value">12.5%</div>
                            </div>
                            <div class="workforce-cell">
                                <div class="label">Hiring Need</div>
                                <div class="value">402</div>
                            </div>
                            <div class="workforce-cell">
                                <div class="label">Time to Fill</div>
                                <div class="value">68 days</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>Workforce Projection</h3>
                            <div class="chart-wrapper">
                                <canvas id="workforceProjectionChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Skills Gap Analysis</h3>
                            <div class="chart-wrapper">
                                <canvas id="skillsGapChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cost Modeling View -->
                <div id="cost-view" class="view-content" style="display: none;">
                    <div class="analytics-panel">
                        <div class="metric-card">
                            <h3>Total Personnel Cost</h3>
                            <div class="value">$178M</div>
                            <div class="change">Annual budget</div>
                        </div>
                        <div class="metric-card">
                            <h3>Cost per FTE</h3>
                            <div class="value">$93.5k</div>
                            <div class="change positive">-2.1% YoY</div>
                        </div>
                        <div class="metric-card">
                            <h3>Benefits & Overhead</h3>
                            <div class="value">32%</div>
                            <div class="change">Of base salary</div>
                        </div>
                        <div class="metric-card">
                            <h3>Contractor Costs</h3>
                            <div class="value">$12.3M</div>
                            <div class="change negative">+15% YoY</div>
                        </div>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>Cost Breakdown by Division</h3>
                            <div class="chart-wrapper">
                                <canvas id="costBreakdownChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Cost Trend Analysis</h3>
                            <div class="chart-wrapper">
                                <canvas id="costTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Skills Matrix View -->
                <div id="skills-view" class="view-content" style="display: none;">
                    <div class="skills-matrix">
                        <h3 style="margin-bottom: 20px;">Organization Skills Matrix</h3>
                        <table class="skills-table">
                            <thead>
                                <tr>
                                    <th>Division</th>
                                    <th>Digital</th>
                                    <th>Data Analytics</th>
                                    <th>Project Mgmt</th>
                                    <th>Customer Service</th>
                                    <th>Technical</th>
                                    <th>Leadership</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="skillsTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="charts-grid" style="margin-top: 24px;">
                        <div class="chart-card">
                            <h3>Overall Skills Distribution</h3>
                            <div class="chart-wrapper">
                                <canvas id="skillsDistributionChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h3>Critical Skills Gap</h3>
                            <div class="chart-wrapper">
                                <canvas id="criticalSkillsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Properties Panel -->
        <div class="properties-panel" id="propertiesPanel">
            <div class="properties-header">
                <h3>Node Properties</h3>
                <button class="btn btn-secondary" onclick="closeProperties()">‚úï</button>
            </div>
            <div class="properties-content">
                <div class="property-group">
                    <h4>Basic Information</h4>
                    <div class="property-field">
                        <label>Position Title</label>
                        <input type="text" id="propTitle" value="">
                    </div>
                    <div class="property-field">
                        <label>Incumbent</label>
                        <input type="text" id="propIncumbent" value="">
                    </div>
                    <div class="property-field">
                        <label>Division</label>
                        <select id="propDivision">
                            <option value="ceo">CEO Office</option>
                            <option value="cnp">Customer & Network</option>
                            <option value="ip">Infrastructure & Place</option>
                            <option value="fcs">Finance & Corporate</option>
                            <option value="pt">PT & Active</option>
                            <option value="partnerships">Partnerships</option>
                            <option value="people">People</option>
                            <option value="strategy">Strategy</option>
                        </select>
                    </div>
                </div>
                
                <div class="property-group">
                    <h4>Organizational Metrics</h4>
                    <div class="property-field">
                        <label>Direct Reports</label>
                        <input type="number" id="propDirectReports" value="">
                    </div>
                    <div class="property-field">
                        <label>Total Reports</label>
                        <input type="number" id="propTotalReports" value="">
                    </div>
                    <div class="property-field">
                        <label>FTE</label>
                        <input type="number" id="propFTE" value="" step="0.1">
                    </div>
                </div>
                
                <div class="property-group">
                    <h4>Cost Information</h4>
                    <div class="property-field">
                        <label>Base Salary</label>
                        <input type="number" id="propSalary" value="">
                    </div>
                    <div class="property-field">
                        <label>Total Cost</label>
                        <input type="number" id="propTotalCost" value="" readonly>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="saveNodeProperties()">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Import Organization Structure</h2>
                <button class="btn btn-secondary" onclick="closeModal('importModal')">‚úï</button>
            </div>
            <div style="margin-bottom: 20px;">
                <p style="color: #6b7280; margin-bottom: 16px;">Upload a CSV file with organizational data to import</p>
                <input type="file" accept=".csv" id="importFile" style="margin-bottom: 16px;">
                <div style="background: #f3f4f6; padding: 12px; border-radius: 6px;">
                    <p style="font-size: 12px; color: #6b7280;">Expected columns: Division, Level3, Level4, Position, FTE, Status</p>
                </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('importModal')">Cancel</button>
                <button class="btn btn-primary" onclick="importData()">Import</button>
            </div>
        </div>
    </div>
    
    <script>
        // Global state and data structures
        let currentView = 'orgchart';
        let editMode = false;
        let selectedNode = null;
        let charts = {};
        let zoomLevel = 1;
        let currentScenario = 'baseline';
        
        // Organization data structure
        let orgData = {
            nodes: {
                'ceo': {
                    id: 'ceo',
                    title: 'Chief Executive',
                    incumbent: 'Dean Kimpton',
                    division: 'ceo',
                    level: 0,
                    parentId: null,
                    childIds: ['cnp', 'ip', 'fcs', 'pt', 'partnerships', 'people', 'strategy', 'transformation', 'legal'],
                    positions: 1,
                    fte: 1,
                    fillRate: 100,
                    baseSalary: 450000,
                    totalCost: 594000
                },
                'cnp': {
                    id: 'cnp',
                    title: 'Customer & Network',
                    incumbent: 'Sarah Johnson',
                    division: 'cnp',
                    level: 1,
                    parentId: 'ceo',
                    childIds: ['cnp-ops', 'cnp-sales', 'cnp-service', 'cnp-digital'],
                    positions: 988,
                    fte: 911,
                    fillRate: 92.2,
                    baseSalary: 280000,
                    totalCost: 370000
                },
                'ip': {
                    id: 'ip',
                    title: 'Infrastructure & Place',
                    incumbent: 'Michael Chen',
                    division: 'ip',
                    level: 1,
                    parentId: 'ceo',
                    childIds: ['ip-network', 'ip-facilities', 'ip-planning'],
                    positions: 435,
                    fte: 401,
                    fillRate: 92.2,
                    baseSalary: 265000,
                    totalCost: 350000
                },
                'fcs': {
                    id: 'fcs',
                    title: 'Finance & Corporate',
                    incumbent: 'Emma Williams',
                    division: 'fcs',
                    level: 1,
                    parentId: 'ceo',
                    childIds: ['fcs-finance', 'fcs-hr', 'fcs-it', 'fcs-procurement'],
                    positions: 443,
                    fte: 393,
                    fillRate: 88.7,
                    baseSalary: 275000,
                    totalCost: 363000
                },
                'pt': {
                    id: 'pt',
                    title: 'PT & Active',
                    incumbent: 'James Wilson',
                    division: 'pt',
                    level: 1,
                    parentId: 'ceo',
                    childIds: ['pt-transport', 'pt-active'],
                    positions: 156,
                    fte: 142,
                    fillRate: 91.0,
                    baseSalary: 245000,
                    totalCost: 323000
                },
                'partnerships': {
                    id: 'partnerships',
                    title: 'Partnerships',
                    incumbent: 'Lisa Anderson',
                    division: 'partnerships',
                    level: 1,
                    parentId: 'ceo',
                    childIds: ['partner-commercial', 'partner-govt'],
                    positions: 87,
                    fte: 81,
                    fillRate: 93.1,
                    baseSalary: 240000,
                    totalCost: 317000
                },
                'people': {
                    id: 'people',
                    title: 'People & Culture',
                    incumbent: 'Robert Brown',
                    division: 'people',
                    level: 1,
                    parentId: 'ceo',
                    childIds: ['people-hr', 'people-culture'],
                    positions: 112,
                    fte: 104,
                    fillRate: 92.9,
                    baseSalary: 235000,
                    totalCost: 310000
                },
                'strategy': {
                    id: 'strategy',
                    title: 'Strategy & Innovation',
                    incumbent: 'Maria Garcia',
                    division: 'strategy',
                    level: 1,
                    parentId: 'ceo',
                    childIds: ['strategy-planning', 'strategy-innovation'],
                    positions: 45,
                    fte: 43,
                    fillRate: 95.6,
                    baseSalary: 255000,
                    totalCost: 337000
                },
                'transformation': {
                    id: 'transformation',
                    title: 'Transformation',
                    incumbent: 'David Lee',
                    division: 'strategy',
                    level: 1,
                    parentId: 'ceo',
                    childIds: [],
                    positions: 28,
                    fte: 26,
                    fillRate: 92.9,
                    baseSalary: 245000,
                    totalCost: 323000
                },
                'legal': {
                    id: 'legal',
                    title: 'Legal & Risk',
                    incumbent: 'Jennifer Taylor',
                    division: 'fcs',
                    level: 1,
                    parentId: 'ceo',
                    childIds: [],
                    positions: 18,
                    fte: 17,
                    fillRate: 94.4,
                    baseSalary: 260000,
                    totalCost: 343000
                },
                // Level 2 nodes
                'cnp-ops': {
                    id: 'cnp-ops',
                    title: 'Network Operations',
                    incumbent: 'Tom Harris',
                    division: 'cnp',
                    level: 2,
                    parentId: 'cnp',
                    childIds: [],
                    positions: 312,
                    fte: 287,
                    fillRate: 92.0,
                    baseSalary: 125000,
                    totalCost: 165000
                },
                'cnp-sales': {
                    id: 'cnp-sales',
                    title: 'Sales & Marketing',
                    incumbent: 'Susan Martinez',
                    division: 'cnp',
                    level: 2,
                    parentId: 'cnp',
                    childIds: [],
                    positions: 245,
                    fte: 225,
                    fillRate: 91.8,
                    baseSalary: 115000,
                    totalCost: 152000
                },
                'cnp-service': {
                    id: 'cnp-service',
                    title: 'Customer Service',
                    incumbent: 'Mark Johnson',
                    division: 'cnp',
                    level: 2,
                    parentId: 'cnp',
                    childIds: [],
                    positions: 287,
                    fte: 264,
                    fillRate: 92.0,
                    baseSalary: 95000,
                    totalCost: 125000
                },
                'cnp-digital': {
                    id: 'cnp-digital',
                    title: 'Digital Channels',
                    incumbent: 'Amy Chen',
                    division: 'cnp',
                    level: 2,
                    parentId: 'cnp',
                    childIds: [],
                    positions: 144,
                    fte: 135,
                    fillRate: 93.8,
                    baseSalary: 135000,
                    totalCost: 178000
                }
            }
        };
        
        // Scenarios data
        let scenarios = {
            baseline: { 
                name: 'Baseline', 
                data: JSON.parse(JSON.stringify(orgData)),
                metrics: {
                    totalFTE: 1904,
                    totalCost: 178,
                    fillRate: 91.9
                }
            },
            integration: { 
                name: 'AC Integration', 
                data: JSON.parse(JSON.stringify(orgData)),
                metrics: {
                    totalFTE: 1748,
                    totalCost: 162,
                    fillRate: 92.5
                }
            },
            optimization: { 
                name: 'Optimization', 
                data: JSON.parse(JSON.stringify(orgData)),
                metrics: {
                    totalFTE: 1656,
                    totalCost: 154,
                    fillRate: 93.2
                }
            },
            growth: { 
                name: 'Growth 2027', 
                data: JSON.parse(JSON.stringify(orgData)),
                metrics: {
                    totalFTE: 1985,
                    totalCost: 185,
                    fillRate: 90.5
                }
            }
        };
        
        // Allocation Management
        let isAllocationEditMode = false;
        let allocationData = [];
        let originalAllocationData = [];
        let financialData = [];
        
        // Initialize application
        window.onload = function() {
            renderOrgChart();
            setupDragAndDrop();
            updateMetrics();
            initializeCharts();
            initializeAllocationData();
        };
        
        // Initialize allocation data
        function initializeAllocationData() {
            const divisionAllocations = [
                {name: 'Customer & Network', total: 799, internal: 781, external: 18},
                {name: 'Infrastructure & Place', total: 343, internal: 269, external: 74},
                {name: 'Finance & Corporate', total: 319, internal: 53, external: 266},
                {name: 'PT & Active', total: 159, internal: 124, external: 35},
                {name: 'Partnerships', total: 75, internal: 63, external: 12},
                {name: 'People & Culture', total: 63, internal: 30, external: 33},
                {name: 'Strategy & Innovation', total: 45, internal: 9, external: 36}
            ];
            
            allocationData = JSON.parse(JSON.stringify(divisionAllocations));
            originalAllocationData = JSON.parse(JSON.stringify(divisionAllocations));
        }
        
        // Render organization chart
        function renderOrgChart() {
            const container = document.getElementById('hierarchyContainer');
            container.innerHTML = '';
            
            const levelMap = {};
            const viewLevel = document.getElementById('viewLevel').value;
            const maxLevel = viewLevel === 'all' ? 10 : parseInt(viewLevel);
            
            // Group nodes by level
            Object.values(orgData.nodes).forEach(node => {
                if (node.level <= maxLevel) {
                    if (!levelMap[node.level]) {
                        levelMap[node.level] = [];
                    }
                    levelMap[node.level].push(node);
                }
            });
            
            // Create hierarchy levels
            Object.keys(levelMap).sort((a, b) => a - b).forEach(level => {
                const levelDiv = document.createElement('div');
                levelDiv.className = 'hierarchy-level';
                levelDiv.setAttribute('data-level', level);
                
                if (level > 0) {
                    const label = document.createElement('span');
                    label.className = 'level-label';
                    label.textContent = level === '1' ? 'Divisions' : `Level ${level}`;
                    levelDiv.appendChild(label);
                }
                
                levelMap[level].forEach(nodeData => {
                    const nodeEl = createNodeElement(nodeData);
                    levelDiv.appendChild(nodeEl);
                });
                
                container.appendChild(levelDiv);
            });
            
            // Draw connections
            setTimeout(() => drawConnections(), 100);
        }
        
        // Create node element
        function createNodeElement(nodeData) {
            const node = document.createElement('div');
            node.className = `org-node division-${nodeData.division}`;
            node.setAttribute('draggable', 'true');
            node.setAttribute('data-id', nodeData.id);
            node.onclick = () => selectNode(node);
            
            // Apply color coding
            applyNodeColor(node, nodeData);
            
            node.innerHTML = `
                <div class="node-title">${nodeData.title}</div>
                <div class="node-subtitle">${nodeData.incumbent}</div>
                <div class="node-metrics">
                    <div class="node-metric">
                        <span class="metric-value">${nodeData.childIds.length || nodeData.positions}</span>
                        <span>${nodeData.childIds.length ? 'Direct Reports' : 'Positions'}</span>
                    </div>
                    <div class="node-metric">
                        <span class="metric-value">${nodeData.childIds.length ? calculateTotalStaff(nodeData.id) : nodeData.fillRate + '%'}</span>
                        <span>${nodeData.childIds.length ? 'Total Staff' : 'Fill Rate'}</span>
                    </div>
                </div>
            `;
            
            return node;
        }
        
        // Apply color coding to nodes
        function applyNodeColor(nodeEl, nodeData) {
            const colorBy = document.getElementById('colorBy').value;
            
            // Remove existing color classes
            nodeEl.style.backgroundColor = '';
            nodeEl.style.borderColor = '';
            
            switch(colorBy) {
                case 'fillRate':
                    const fillRate = nodeData.fillRate;
                    if (fillRate >= 95) {
                        nodeEl.style.backgroundColor = '#d1fae5';
                        nodeEl.style.borderColor = '#10b981';
                    } else if (fillRate >= 90) {
                        nodeEl.style.backgroundColor = '#dbeafe';
                        nodeEl.style.borderColor = '#3b82f6';
                    } else if (fillRate >= 85) {
                        nodeEl.style.backgroundColor = '#fef3c7';
                        nodeEl.style.borderColor = '#f59e0b';
                    } else {
                        nodeEl.style.backgroundColor = '#fee2e2';
                        nodeEl.style.borderColor = '#ef4444';
                    }
                    break;
                    
                case 'spanOfControl':
                    const span = nodeData.childIds.length;
                    if (span === 0) {
                        nodeEl.style.backgroundColor = '#f3f4f6';
                    } else if (span >= 6 && span <= 8) {
                        nodeEl.style.backgroundColor = '#d1fae5';
                        nodeEl.style.borderColor = '#10b981';
                    } else if (span >= 4 && span <= 10) {
                        nodeEl.style.backgroundColor = '#dbeafe';
                        nodeEl.style.borderColor = '#3b82f6';
                    } else {
                        nodeEl.style.backgroundColor = '#fef3c7';
                        nodeEl.style.borderColor = '#f59e0b';
                    }
                    break;
                    
                case 'cost':
                    const costPerFTE = nodeData.totalCost / (nodeData.fte || 1);
                    if (costPerFTE > 200000) {
                        nodeEl.style.backgroundColor = '#fee2e2';
                        nodeEl.style.borderColor = '#ef4444';
                    } else if (costPerFTE > 150000) {
                        nodeEl.style.backgroundColor = '#fef3c7';
                        nodeEl.style.borderColor = '#f59e0b';
                    } else if (costPerFTE > 100000) {
                        nodeEl.style.backgroundColor = '#dbeafe';
                        nodeEl.style.borderColor = '#3b82f6';
                    } else {
                        nodeEl.style.backgroundColor = '#d1fae5';
                        nodeEl.style.borderColor = '#10b981';
                    }
                    break;
            }
        }
        
        // Calculate total staff under a node
        function calculateTotalStaff(nodeId) {
            const node = orgData.nodes[nodeId];
            let total = node.positions || 1;
            
            node.childIds.forEach(childId => {
                if (orgData.nodes[childId]) {
                    total += calculateTotalStaff(childId);
                }
            });
            
            return total;
        }
        
        // Draw connections between nodes
        function drawConnections() {
            const svg = document.getElementById('connectionsSvg');
            const container = document.getElementById('hierarchyContainer');
            svg.innerHTML = '';
            
            // Set SVG dimensions
            svg.setAttribute('width', container.scrollWidth);
            svg.setAttribute('height', container.scrollHeight);
            
            Object.values(orgData.nodes).forEach(node => {
                if (node.childIds.length > 0) {
                    const parentEl = document.querySelector(`[data-id="${node.id}"]`);
                    if (!parentEl) return;
                    
                    const parentRect = parentEl.getBoundingClientRect();
                    const containerRect = container.getBoundingClientRect();
                    
                    node.childIds.forEach(childId => {
                        const childEl = document.querySelector(`[data-id="${childId}"]`);
                        if (!childEl) return;
                        
                        const childRect = childEl.getBoundingClientRect();
                        
                        // Calculate positions relative to container
                        const startX = parentRect.left + parentRect.width / 2 - containerRect.left;
                        const startY = parentRect.bottom - containerRect.top;
                        const endX = childRect.left + childRect.width / 2 - containerRect.left;
                        const endY = childRect.top - containerRect.top;
                        
                        // Create path
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        const midY = (startY + endY) / 2;
                        const d = `M ${startX} ${startY} C ${startX} ${midY}, ${endX} ${midY}, ${endX} ${endY}`;
                        
                        path.setAttribute('d', d);
                        path.setAttribute('class', 'connection-line');
                        svg.appendChild(path);
                    });
                }
            });
        }
        
        // Update metrics panel
        function updateMetrics() {
            let totalHeadcount = 0;
            let totalFTE = 0;
            let totalManagers = 0;
            let totalSpan = 0;
            let maxLevel = 0;
            
            Object.values(orgData.nodes).forEach(node => {
                totalHeadcount += node.positions || 1;
                totalFTE += node.fte || 0;
                if (node.childIds.length > 0) {
                    totalManagers++;
                    totalSpan += node.childIds.length;
                }
                maxLevel = Math.max(maxLevel, node.level);
            });
            
            const avgSpan = totalManagers > 0 ? (totalSpan / totalManagers).toFixed(1) : 0;
            
            document.getElementById('totalHeadcount').textContent = totalHeadcount.toLocaleString();
            document.getElementById('totalFTE').textContent = Math.round(totalFTE).toLocaleString();
            document.getElementById('avgSpan').textContent = avgSpan;
            document.getElementById('orgLayers').textContent = maxLevel + 1;
        }
        
        // View Management
        function showView(elem, viewName) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            elem.classList.add('active');
            
            // Hide all views
            document.querySelectorAll('.view-content').forEach(view => {
                view.style.display = 'none';
            });
            
            // Show selected view
            document.getElementById(viewName + '-view').style.display = 'block';
            
            // Update header title
            const titles = {
                orgchart: 'Organizational Chart',
                scenarios: 'Scenario Planning',
                analytics: 'Organizational Analytics',
                workforce: 'Workforce Planning',
                cost: 'Cost Modeling',
                skills: 'Skills Matrix'
            };
            document.getElementById('viewTitle').textContent = titles[viewName];
            
            // Update toolbar visibility
            document.getElementById('toolbar').style.display = viewName === 'orgchart' ? 'flex' : 'none';
            
            currentView = viewName;
            
            // Initialize view-specific content
            if (viewName === 'analytics') {
                initializeAnalyticsCharts();
            } else if (viewName === 'scenarios') {
                // Reset to overview when entering scenarios
                document.getElementById('scenarioViewType').value = 'overview';
                updateScenarioViewType();
                initializeScenarioCharts();
            } else if (viewName === 'workforce') {
                initializeWorkforceCharts();
            } else if (viewName === 'cost') {
                initializeCostCharts();
            } else if (viewName === 'skills') {
                initializeSkillsMatrix();
            }
        }
        
        // Scenario Management
        function toggleScenarioMode() {
            editMode = !editMode;
            const btn = document.getElementById('scenarioModeText');
            btn.textContent = editMode ? 'Edit Mode' : 'View Mode';
            
            // Update node appearance
            document.querySelectorAll('.org-node').forEach(node => {
                node.style.cursor = editMode ? 'move' : 'pointer';
            });
            
            // Toggle edit mode class
            document.getElementById('orgChart').classList.toggle('edit-mode', editMode);
        }
        
        function selectScenario(tab, scenarioId) {
            // Update tab appearance
            document.querySelectorAll('.scenario-tab').forEach(t => {
                t.classList.remove('active');
            });
            tab.classList.add('active');
            
            currentScenario = scenarioId;
            updateScenarioMetrics();
            
            // Update allocation data if in allocation view
            if (document.getElementById('scenarioViewType').value === 'allocation') {
                updateAllocationData();
                buildAllocationTable();
                updateAllocationChart();
            }
        }
        
        function updateScenarioMetrics() {
            const scenario = scenarios[currentScenario];
            if (!scenario) return;
            
            const baseline = scenarios.baseline.metrics;
            const current = scenario.metrics;
            
            // Update scenario impact
            const costImpact = (current.totalCost - baseline.totalCost).toFixed(1);
            document.getElementById('scenarioImpact').textContent = 
                costImpact > 0 ? `+$${costImpact}M` : `-$${Math.abs(costImpact)}M`;
            
            // Update FTE change
            const fteChange = current.totalFTE - baseline.totalFTE;
            document.getElementById('fteChange').textContent = 
                fteChange > 0 ? `+${fteChange}` : `${fteChange}`;
            
            // Update affected staff (simulated)
            const affectedStaff = Math.abs(fteChange) + Math.floor(Math.random() * 200);
            document.getElementById('affectedStaff').textContent = affectedStaff;
        }
        
        // New Scenario View Management
        function updateScenarioViewType() {
            const viewType = document.getElementById('scenarioViewType').value;
            
            // Hide all views
            document.getElementById('scenario-overview').style.display = 'none';
            document.getElementById('scenario-allocation').style.display = 'none';
            document.getElementById('scenario-financial').style.display = 'none';
            
            // Show selected view
            document.getElementById(`scenario-${viewType}`).style.display = 'block';
            
            // Show/hide allocation controls
            const allocationModeBtn = document.getElementById('allocationModeBtn');
            const resetBtn = document.getElementById('resetAllocationBtn');
            const hint = document.getElementById('allocationHint');
            
            if (viewType === 'allocation') {
                allocationModeBtn.style.display = 'inline-block';
                resetBtn.style.display = isAllocationEditMode ? 'inline-block' : 'none';
                initializeAllocationView();
            } else {
                allocationModeBtn.style.display = 'none';
                resetBtn.style.display = 'none';
                hint.style.display = 'none';
            }
            
            if (viewType === 'financial') {
                initializeFinancialView();
            }
        }
        
        function updateAllocationData() {
            // Update allocation data based on current scenario
            if (currentScenario === 'optimization') {
                // Adjust allocations for optimization scenario
                allocationData.forEach(division => {
                    division.external = Math.round(division.external * 1.2);
                    division.internal = division.total - division.external;
                });
            } else if (currentScenario === 'growth') {
                // Adjust for growth scenario
                allocationData.forEach(division => {
                    division.total = Math.round(division.total * 1.1);
                    division.internal = Math.round(division.internal * 1.1);
                    division.external = division.total - division.internal;
                });
            }
        }
        
        function initializeAllocationView() {
            if (allocationData.length === 0) {
                initializeAllocationData();
            }
            updateAllocationData();
            buildAllocationTable();
            updateAllocationTotals();
            updateAllocationChart();
        }
        
        function toggleAllocationMode() {
            isAllocationEditMode = !isAllocationEditMode;
            const btn = document.getElementById('allocationModeBtn');
            const resetBtn = document.getElementById('resetAllocationBtn');
            const hint = document.getElementById('allocationHint');
            const detailsCard = document.querySelector('#scenario-allocation .scenario-details-card');
            
            if (isAllocationEditMode) {
                btn.textContent = 'Save Changes';
                btn.classList.add('edit-active');
                resetBtn.style.display = 'inline-block';
                hint.style.display = 'block';
                detailsCard.classList.add('edit-mode');
            } else {
                btn.textContent = 'Policy Mode';
                btn.classList.remove('edit-active');
                resetBtn.style.display = 'none';
                hint.style.display = 'none';
                detailsCard.classList.remove('edit-mode');
                
                // Update financial view with new allocations
                updateFinancialFromAllocation();
            }
            
            buildAllocationTable();
        }
        
        function resetAllocations() {
            allocationData = JSON.parse(JSON.stringify(originalAllocationData));
            buildAllocationTable();
            updateAllocationTotals();
            updateAllocationChart();
            
            const tag = document.getElementById('allocationScenarioTag');
            if (tag) tag.textContent = 'Policy';
        }
        
        function buildAllocationTable() {
            const tbody = document.getElementById('allocationTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            allocationData.forEach((division, index) => {
                const percentExternal = division.total > 0 ? 
                    ((division.external / division.total) * 100).toFixed(1) : '0.0';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${division.name}</td>
                    <td id="total-${index}">${division.total}</td>
                    <td class="editable-cell">
                        ${isAllocationEditMode ? 
                            `<input type="number" class="allocation-input" id="internal-${index}" 
                             value="${division.internal}" min="0" onchange="updateAllocation(${index}, 'internal', this.value)">` 
                            : division.internal}
                    </td>
                    <td class="editable-cell">
                        ${isAllocationEditMode ? 
                            `<input type="number" class="allocation-input" id="external-${index}" 
                             value="${division.external}" min="0" onchange="updateAllocation(${index}, 'external', this.value)">` 
                            : division.external}
                    </td>
                    <td id="percent-${index}">${percentExternal}%</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateAllocation(index, type, value) {
            const numValue = Math.max(0, parseInt(value) || 0);
            allocationData[index][type] = numValue;
            
            // Update total
            if (type === 'internal') {
                allocationData[index].total = numValue + allocationData[index].external;
            } else {
                allocationData[index].total = allocationData[index].internal + numValue;
            }
            
            // Update display
            document.getElementById(`total-${index}`).textContent = allocationData[index].total;
            const percentExternal = allocationData[index].total > 0 ? 
                ((allocationData[index].external / allocationData[index].total) * 100).toFixed(1) : '0.0';
            document.getElementById(`percent-${index}`).textContent = percentExternal + '%';
            
            // Check if custom
            let isCustom = false;
            for (let i = 0; i < allocationData.length; i++) {
                if (allocationData[i].internal !== originalAllocationData[i].internal ||
                    allocationData[i].external !== originalAllocationData[i].external) {
                    isCustom = true;
                    break;
                }
            }
            
            const tag = document.getElementById('allocationScenarioTag');
            if (tag) tag.textContent = isCustom ? 'Custom' : 'Policy';
            
            updateAllocationTotals();
            updateAllocationChart();
        }
        
        function updateAllocationTotals() {
            let totalPositions = 0;
            let totalInternal = 0;
            let totalExternal = 0;
            
            allocationData.forEach(division => {
                totalPositions += division.total;
                totalInternal += division.internal;
                totalExternal += division.external;
            });
            
            document.getElementById('totalPositions').textContent = totalPositions.toLocaleString();
            document.getElementById('internalReorg').textContent = totalInternal.toLocaleString();
            document.getElementById('externalTransfer').textContent = totalExternal.toLocaleString();
            
            const percentInternal = totalPositions > 0 ? 
                ((totalInternal / totalPositions) * 100).toFixed(1) : '0.0';
            const percentExternal = totalPositions > 0 ? 
                ((totalExternal / totalPositions) * 100).toFixed(1) : '0.0';
            
            document.getElementById('percentInternal').textContent = percentInternal + '%';
            document.getElementById('percentExternal').textContent = percentExternal + '%';
            
            document.getElementById('footerTotalCurrent').textContent = totalPositions.toLocaleString();
            document.getElementById('footerTotalInternal').textContent = totalInternal.toLocaleString();
            document.getElementById('footerTotalExternal').textContent = totalExternal.toLocaleString();
            document.getElementById('footerPercentExternal').textContent = percentExternal + '%';
        }
        
        function updateAllocationChart() {
            const canvas = document.getElementById('staffAllocationChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const labels = allocationData.map(d => d.name);
            const internalData = allocationData.map(d => d.internal);
            const externalData = allocationData.map(d => d.external);
            
            if (charts.staffAllocation) {
                charts.staffAllocation.destroy();
            }
            
            charts.staffAllocation = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Internal Reorganization',
                            data: internalData,
                            backgroundColor: '#3b82f6'
                        },
                        {
                            label: 'External Transfer',
                            data: externalData,
                            backgroundColor: '#10b981'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        xAxes: [{ stacked: true }],
                        yAxes: [{ stacked: true, ticks: { beginAtZero: true } }]
                    }
                }
            });
        }
        
        // Financial View Management
        function initializeFinancialView() {
            financialData = [
                {name: 'Staff Salaries & Benefits', current: 120.0, projected: 110.0},
                {name: 'IT & Systems', current: 25.0, projected: 20.0},
                {name: 'Facilities & Property', current: 15.0, projected: 12.0},
                {name: 'Professional Services', current: 8.0, projected: 6.0},
                {name: 'Administration', current: 12.0, projected: 8.0}
            ];
            
            updateFinancialFromAllocation();
            buildFinancialTable();
            updateFinancialTotals();
            updateFinancialCharts();
        }
        
        function updateFinancialFromAllocation() {
            // Calculate financial impact based on allocation
            let totalExternal = 0;
            let totalStaff = 0;
            
            allocationData.forEach(division => {
                totalExternal += division.external;
                totalStaff += division.total;
            });
            
            // Calculate efficiency factor
            const externalPercent = totalStaff > 0 ? totalExternal / totalStaff : 0.262;
            const efficiencyFactor = 1 - (externalPercent * 0.15); // 15% efficiency gain for external transfers
            
            // Update financial projections
            financialData[0].projected = Math.round(120.0 * efficiencyFactor * 10) / 10;
            financialData[1].projected = Math.round(25.0 * (0.8 + 0.2 * efficiencyFactor) * 10) / 10;
            financialData[2].projected = Math.round(15.0 * (0.85 + 0.15 * efficiencyFactor) * 10) / 10;
            financialData[3].projected = Math.round(8.0 * efficiencyFactor * 10) / 10;
            financialData[4].projected = Math.round(12.0 * (0.7 + 0.3 * efficiencyFactor) * 10) / 10;
        }
        
        function buildFinancialTable() {
            const tbody = document.getElementById('financialTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            financialData.forEach(category => {
                const savings = category.current - category.projected;
                const savingsPercent = category.current > 0 ? 
                    ((savings / category.current) * 100).toFixed(1) : '0.0';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.name}</td>
                    <td class="cost-value">$${category.current.toFixed(1)}M</td>
                    <td class="cost-value">$${category.projected.toFixed(1)}M</td>
                    <td class="cost-value ${savings > 0 ? 'savings-positive' : ''}">
                        $${savings.toFixed(1)}M
                    </td>
                    <td class="${savings > 0 ? 'savings-positive' : ''}">${savingsPercent}%</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateFinancialTotals() {
            let totalCurrent = 0;
            let totalProjected = 0;
            
            financialData.forEach(category => {
                totalCurrent += category.current;
                totalProjected += category.projected;
            });
            
            const totalSavings = totalCurrent - totalProjected;
            const savingsPercent = totalCurrent > 0 ? 
                ((totalSavings / totalCurrent) * 100).toFixed(1) : '0.0';
            
            document.getElementById('financialTotalCurrent').textContent = `$${totalCurrent.toFixed(1)}M`;
            document.getElementById('financialTotalProjected').textContent = `$${totalProjected.toFixed(1)}M`;
            document.getElementById('financialTotalSavings').textContent = `$${totalSavings.toFixed(1)}M`;
            document.getElementById('financialTotalPercent').textContent = `${savingsPercent}%`;
            
            document.getElementById('annualSavings').textContent = `$${Math.round(totalSavings)}M`;
            
            // Update ROI
            const transitionCost = 10;
            const roi = transitionCost > 0 ? Math.round((totalSavings / transitionCost) * 100) : 0;
            document.getElementById('roiPercent').textContent = `${roi}% ROI`;
            
            // Update payback period
            const paybackMonths = totalSavings > 0 ? Math.ceil((transitionCost / totalSavings) * 12) : 0;
            document.getElementById('paybackPeriod').textContent = paybackMonths;
            
            // Update efficiency metrics
            let totalStaff = 0;
            allocationData.forEach(d => totalStaff += d.total);
            
            const costPerFTE = totalStaff > 0 ? 
                ((totalProjected * 1000) / totalStaff).toFixed(1) : '88.8';
            document.getElementById('costPerFTE').textContent = `$${costPerFTE}k`;
            document.getElementById('efficiencyGain').textContent = `${savingsPercent}%`;
        }
        
        function updateFinancialCharts() {
            // Update savings by category chart
            const canvas = document.getElementById('savingsCategoryChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const labels = financialData.map(d => d.name);
            const savings = financialData.map(d => (d.current - d.projected));
            const colors = savings.map(s => s > 0 ? '#10b981' : '#ef4444');
            
            if (charts.savingsCategory) {
                charts.savingsCategory.destroy();
            }
            
            charts.savingsCategory = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Annual Savings ($M)',
                        data: savings,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true,
                                callback: function(value) {
                                    return '$' + value.toFixed(1) + 'M';
                                }
                            }
                        }]
                    }
                }
            });
        }
        
        function createNewScenario() {
            const name = prompt('Enter scenario name:');
            if (name) {
                const id = name.toLowerCase().replace(/\s+/g, '-');
                scenarios[id] = { 
                    name: name, 
                    data: JSON.parse(JSON.stringify(orgData)),
                    metrics: {
                        totalFTE: Math.floor(1900 + Math.random() * 200),
                        totalCost: Math.floor(170 + Math.random() * 20),
                        fillRate: 90 + Math.random() * 5
                    }
                };
                
                // Add new tab
                const tabContainer = document.querySelector('.scenario-tabs');
                const newTab = document.createElement('button');
                newTab.className = 'scenario-tab';
                newTab.textContent = name;
                newTab.onclick = function() { selectScenario(this, id); };
                tabContainer.insertBefore(newTab, tabContainer.lastElementChild);
            }
        }
        
        // Node Selection
        function selectNode(node) {
            // Remove previous selection
            document.querySelectorAll('.org-node').forEach(n => {
                n.classList.remove('selected');
            });
            
            // Add selection to clicked node
            node.classList.add('selected');
            selectedNode = node;
            
            // Open properties panel
            document.getElementById('propertiesPanel').classList.add('open');
            
            // Update properties panel with node data
            updatePropertiesPanel(node);
        }
        
        function updatePropertiesPanel(node) {
            const nodeId = node.getAttribute('data-id');
            const nodeData = orgData.nodes[nodeId];
            
            if (!nodeData) return;
            
            document.getElementById('propTitle').value = nodeData.title;
            document.getElementById('propIncumbent').value = nodeData.incumbent;
            document.getElementById('propDivision').value = nodeData.division;
            document.getElementById('propDirectReports').value = nodeData.childIds.length;
            document.getElementById('propTotalReports').value = calculateTotalStaff(nodeId);
            document.getElementById('propFTE').value = nodeData.fte || '';
            document.getElementById('propSalary').value = nodeData.baseSalary || '';
            document.getElementById('propTotalCost').value = nodeData.totalCost || '';
        }
        
        function saveNodeProperties() {
            if (!selectedNode) return;
            
            const nodeId = selectedNode.getAttribute('data-id');
            const nodeData = orgData.nodes[nodeId];
            
            if (!nodeData) return;
            
            // Update node data
            nodeData.title = document.getElementById('propTitle').value;
            nodeData.incumbent = document.getElementById('propIncumbent').value;
            nodeData.division = document.getElementById('propDivision').value;
            nodeData.fte = parseFloat(document.getElementById('propFTE').value) || nodeData.fte;
            nodeData.baseSalary = parseInt(document.getElementById('propSalary').value) || nodeData.baseSalary;
            nodeData.totalCost = parseInt(document.getElementById('propTotalCost').value) || nodeData.totalCost;
            
            // Re-render the org chart
            renderOrgChart();
            updateMetrics();
            
            // Show success message
            alert('Node properties saved successfully!');
        }
        
        function closeProperties() {
            document.getElementById('propertiesPanel').classList.remove('open');
            if (selectedNode) {
                selectedNode.classList.remove('selected');
                selectedNode = null;
            }
        }
        
        // Drag and Drop
        function setupDragAndDrop() {
            document.addEventListener('dragstart', handleDragStart);
            document.addEventListener('dragend', handleDragEnd);
            document.addEventListener('dragover', handleDragOver);
            document.addEventListener('drop', handleDrop);
        }
        
        let draggedNode = null;
        let draggedNodeId = null;
        
        function handleDragStart(e) {
            if (!e.target.classList.contains('org-node') || !editMode) {
                e.preventDefault();
                return;
            }
            
            draggedNode = e.target;
            draggedNodeId = draggedNode.getAttribute('data-id');
            draggedNode.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragEnd(e) {
            if (draggedNode) {
                draggedNode.classList.remove('dragging');
                draggedNode = null;
                draggedNodeId = null;
            }
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            const targetNode = e.target.closest('.org-node');
            if (draggedNode && targetNode && draggedNode !== targetNode && editMode) {
                const targetNodeId = targetNode.getAttribute('data-id');
                
                // Update org structure
                reorganizeNodes(draggedNodeId, targetNodeId);
                
                // Re-render
                renderOrgChart();
                updateMetrics();
            }
            
            return false;
        }
        
        function reorganizeNodes(sourceId, targetId) {
            const sourceNode = orgData.nodes[sourceId];
            const targetNode = orgData.nodes[targetId];
            
            if (!sourceNode || !targetNode) return;
            
            // Remove from old parent
            if (sourceNode.parentId) {
                const oldParent = orgData.nodes[sourceNode.parentId];
                if (oldParent) {
                    oldParent.childIds = oldParent.childIds.filter(id => id !== sourceId);
                }
            }
            
            // Add to new parent
            sourceNode.parentId = targetId;
            targetNode.childIds.push(sourceId);
            
            // Update level
            sourceNode.level = targetNode.level + 1;
            
            // Update children levels recursively
            updateChildLevels(sourceId);
        }
        
        function updateChildLevels(nodeId) {
            const node = orgData.nodes[nodeId];
            if (!node) return;
            
            node.childIds.forEach(childId => {
                const child = orgData.nodes[childId];
                if (child) {
                    child.level = node.level + 1;
                    updateChildLevels(childId);
                }
            });
        }
        
        // Zoom functions
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel * 1.2, 3);
            applyZoom();
        }
        
        function zoomOut() {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.3);
            applyZoom();
        }
        
        function fitToScreen() {
            zoomLevel = 1;
            applyZoom();
            
            // Center the org chart
            const container = document.getElementById('orgChart');
            container.scrollTop = 0;
            container.scrollLeft = 0;
        }
        
        function applyZoom() {
            const wrapper = document.getElementById('orgChartWrapper');
            wrapper.style.transform = `scale(${zoomLevel})`;
        }
        
        // Update functions
        function updateOrgView() {
            renderOrgChart();
        }
        
        function updateNodeColors() {
            document.querySelectorAll('.org-node').forEach(node => {
                const nodeId = node.getAttribute('data-id');
                const nodeData = orgData.nodes[nodeId];
                if (nodeData) {
                    applyNodeColor(node, nodeData);
                }
            });
        }
        
        // Chart initialization functions
        function initializeCharts() {
            // Charts will be initialized when their respective views are shown
        }
        
        function initializeAnalyticsCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart && chart.destroy) {
                    chart.destroy();
                }
            });
            charts = {};
            
            // Span of Control Chart
            const spanCtx = document.getElementById('spanControlChart').getContext('2d');
            charts.spanControl = new Chart(spanCtx, {
                type: 'bar',
                data: {
                    labels: ['1-3', '4-6', '7-9', '10-12', '13-15', '>15'],
                    datasets: [{
                        label: 'Number of Managers',
                        data: [45, 132, 87, 34, 12, 5],
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        yAxes: [{ ticks: { beginAtZero: true } }]
                    }
                }
            });
            
            // Layers Chart
            const layersCtx = document.getElementById('layersChart').getContext('2d');
            charts.layers = new Chart(layersCtx, {
                type: 'horizontalBar',
                data: {
                    labels: ['CEO', 'Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5', 'Level 6'],
                    datasets: [{
                        label: 'Positions',
                        data: [1, 9, 54, 287, 892, 745, 312],
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        xAxes: [{ ticks: { beginAtZero: true } }]
                    }
                }
            });
            
            // Cost per FTE Chart
            const costCtx = document.getElementById('costPerFTEChart').getContext('2d');
            charts.costPerFTE = new Chart(costCtx, {
                type: 'bar',
                data: {
                    labels: ['Customer & Network', 'Infrastructure', 'Finance', 'PT & Active', 'Partnerships', 'People', 'Strategy'],
                    datasets: [{
                        label: 'Cost per FTE ($k)',
                        data: [87, 92, 95, 83, 98, 102, 115],
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        yAxes: [{ ticks: { beginAtZero: true } }]
                    }
                }
            });
            
            // Fill Rate Trends
            const fillCtx = document.getElementById('fillRateChart').getContext('2d');
            charts.fillRate = new Chart(fillCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Overall Fill Rate %',
                        data: [89.2, 90.1, 90.8, 91.3, 91.7, 91.9],
                        borderColor: '#10b981',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: false,
                                min: 85,
                                max: 95
                            }
                        }]
                    }
                }
            });
        }
        
        function initializeScenarioCharts() {
            // Initialize overview charts if in overview mode
            if (document.getElementById('scenarioViewType').value === 'overview') {
                // Scenario Comparison Chart
                if (charts.scenarioComparison) charts.scenarioComparison.destroy();
                
                const scenarioCtx = document.getElementById('scenarioComparisonChart').getContext('2d');
                charts.scenarioComparison = new Chart(scenarioCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.values(scenarios).map(s => s.name),
                        datasets: [{
                            label: 'Total FTE',
                            data: Object.values(scenarios).map(s => s.metrics.totalFTE),
                            backgroundColor: '#3b82f6'
                        }, {
                            label: 'Total Cost ($M)',
                            data: Object.values(scenarios).map(s => s.metrics.totalCost),
                            backgroundColor: '#ef4444'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                
                // Cost Impact Chart
                if (charts.costImpact) charts.costImpact.destroy();
                
                const costImpactCtx = document.getElementById('costImpactChart').getContext('2d');
                charts.costImpact = new Chart(costImpactCtx, {
                    type: 'line',
                    data: {
                        labels: ['Q1 2025', 'Q2 2025', 'Q3 2025', 'Q4 2025', 'Q1 2026', 'Q2 2026'],
                        datasets: [{
                            label: 'Baseline',
                            data: [44.5, 44.5, 44.5, 44.5, 44.5, 44.5],
                            borderColor: '#6b7280',
                            borderDash: [5, 5],
                            fill: false
                        }, {
                            label: 'AC Integration',
                            data: [44.5, 43.8, 42.9, 41.8, 40.5, 40.5],
                            borderColor: '#3b82f6',
                            fill: false
                        }, {
                            label: 'Optimization',
                            data: [44.5, 43.2, 41.5, 39.8, 38.5, 38.5],
                            borderColor: '#10b981',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            yAxes: [{
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value + 'M';
                                    }
                                }
                            }]
                        }
                    }
                });
            } else if (document.getElementById('scenarioViewType').value === 'allocation') {
                initializeAllocationView();
            } else if (document.getElementById('scenarioViewType').value === 'financial') {
                initializeFinancialView();
            }
        }
        
        function initializeWorkforceCharts() {
            // Workforce Projection Chart
            if (charts.workforceProjection) charts.workforceProjection.destroy();
            
            const projectionCtx = document.getElementById('workforceProjectionChart').getContext('2d');
            charts.workforceProjection = new Chart(projectionCtx, {
                type: 'line',
                data: {
                    labels: ['2025', '2026', '2027', '2028', '2029', '2030'],
                    datasets: [{
                        label: 'Required HC',
                        data: [2300, 2380, 2450, 2520, 2590, 2650],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true
                    }, {
                        label: 'Projected HC',
                        data: [2113, 2180, 2250, 2310, 2370, 2420],
                        borderColor: '#10b981',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Skills Gap Chart
            if (charts.skillsGap) charts.skillsGap.destroy();
            
            const skillsCtx = document.getElementById('skillsGapChart').getContext('2d');
            charts.skillsGap = new Chart(skillsCtx, {
                type: 'radar',
                data: {
                    labels: ['Digital', 'Data Analytics', 'Project Mgmt', 'Customer Service', 'Technical', 'Leadership'],
                    datasets: [{
                        label: 'Current',
                        data: [65, 55, 80, 85, 75, 70],
                        borderColor: '#6b7280',
                        backgroundColor: 'rgba(107, 114, 128, 0.2)'
                    }, {
                        label: 'Required',
                        data: [85, 80, 85, 90, 85, 85],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scale: {
                        ticks: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        function initializeCostCharts() {
            // Cost Breakdown Chart
            if (charts.costBreakdown) charts.costBreakdown.destroy();
            
            const breakdownCtx = document.getElementById('costBreakdownChart').getContext('2d');
            charts.costBreakdown = new Chart(breakdownCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Salaries', 'Benefits', 'Training', 'Facilities', 'IT', 'Other'],
                    datasets: [{
                        data: [120, 28, 5, 12, 8, 5],
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', 
                            '#ef4444', '#8b5cf6', '#6b7280'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Cost Trend Chart
            if (charts.costTrend) charts.costTrend.destroy();
            
            const trendCtx = document.getElementById('costTrendChart').getContext('2d');
            charts.costTrend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: ['2020', '2021', '2022', '2023', '2024', '2025'],
                    datasets: [{
                        label: 'Total Cost ($M)',
                        data: [165, 168, 172, 174, 176, 178],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        yAxes: [{
                            ticks: {
                                callback: function(value) {
                                    return '$' + value + 'M';
                                }
                            }
                        }]
                    }
                }
            });
        }
        
        function initializeSkillsMatrix() {
            // Generate skills matrix data
            const divisions = ['Customer & Network', 'Infrastructure', 'Finance', 'PT & Active', 'Partnerships', 'People', 'Strategy'];
            const tbody = document.getElementById('skillsTableBody');
            tbody.innerHTML = '';
            
            divisions.forEach(division => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${division}</td>
                    <td>${generateSkillLevel()}</td>
                    <td>${generateSkillLevel()}</td>
                    <td>${generateSkillLevel()}</td>
                    <td>${generateSkillLevel()}</td>
                    <td>${generateSkillLevel()}</td>
                    <td>${generateSkillLevel()}</td>
                    <td><button class="btn btn-secondary" onclick="alert('Opening skills development plan...')">Plan</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Initialize skills charts
            if (charts.skillsDistribution) charts.skillsDistribution.destroy();
            
            const distCtx = document.getElementById('skillsDistributionChart').getContext('2d');
            charts.skillsDistribution = new Chart(distCtx, {
                type: 'pie',
                data: {
                    labels: ['Expert', 'Proficient', 'Competent', 'Developing', 'None'],
                    datasets: [{
                        data: [15, 25, 35, 20, 5],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#6b7280', '#e5e7eb']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            if (charts.criticalSkills) charts.criticalSkills.destroy();
            
            const criticalCtx = document.getElementById('criticalSkillsChart').getContext('2d');
            charts.criticalSkills = new Chart(criticalCtx, {
                type: 'horizontalBar',
                data: {
                    labels: ['Cloud Architecture', 'Data Science', 'Cybersecurity', 'AI/ML', 'DevOps'],
                    datasets: [{
                        label: 'Gap (positions)',
                        data: [23, 18, 15, 12, 8],
                        backgroundColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        xAxes: [{ ticks: { beginAtZero: true } }]
                    }
                }
            });
        }
        
        function generateSkillLevel() {
            const levels = [
                { class: 'expert', label: 'Expert' },
                { class: 'proficient', label: 'Proficient' },
                { class: 'competent', label: 'Competent' },
                { class: 'developing', label: 'Developing' },
                { class: 'none', label: 'None' }
            ];
            
            const level = levels[Math.floor(Math.random() * levels.length)];
            return `<span class="skill-level ${level.class}" title="${level.label}"></span>`;
        }
        
        // Utility Functions
        function toggleDropdown(button) {
            const currentDropdown = button.parentElement;
            const isOpen = currentDropdown.classList.contains('open');
            
            // Close all dropdowns
            document.querySelectorAll('.dropdown.open').forEach(dropdown => {
                dropdown.classList.remove('open');
            });
            
            // If not open, open current dropdown
            if (!isOpen) {
                currentDropdown.classList.add('open');
            }
        }
        
        function saveScenario() {
            const scenarioName = prompt('Save current state as:', `Scenario ${Object.keys(scenarios).length + 1}`);
            if (scenarioName) {
                const id = scenarioName.toLowerCase().replace(/\s+/g, '-');
                scenarios[id] = {
                    name: scenarioName,
                    data: JSON.parse(JSON.stringify(orgData)),
                    metrics: {
                        totalFTE: calculateTotalFTE(),
                        totalCost: calculateTotalCost(),
                        fillRate: calculateFillRate()
                    }
                };
                alert(`Scenario "${scenarioName}" saved successfully!`);
            }
        }
        
        function calculateTotalFTE() {
            return Object.values(orgData.nodes).reduce((sum, node) => sum + (node.fte || 0), 0);
        }
        
        function calculateTotalCost() {
            return Math.round(Object.values(orgData.nodes).reduce((sum, node) => sum + (node.totalCost || 0), 0) / 1000000);
        }
        
        function calculateFillRate() {
            const totalPositions = Object.values(orgData.nodes).reduce((sum, node) => sum + (node.positions || 0), 0);
            const totalFilled = Object.values(orgData.nodes).reduce((sum, node) => sum + (node.fte || 0), 0);
            return Math.round((totalFilled / totalPositions) * 100 * 10) / 10;
        }
        
        function exportData() {
            const csvContent = generateCSV();
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `org_structure_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function generateCSV() {
            let csv = 'Division,Title,Incumbent,Level,Positions,FTE,Fill Rate,Base Salary,Total Cost\n';
            
            Object.values(orgData.nodes).forEach(node => {
                csv += `"${node.division}","${node.title}","${node.incumbent}",${node.level},${node.positions},${node.fte},${node.fillRate},${node.baseSalary},${node.totalCost}\n`;
            });
            
            return csv;
        }
        
        function showImportModal() {
            document.getElementById('importModal').classList.add('open');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('open');
        }
        
        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Parse CSV (simplified)
                    const lines = e.target.result.split('\n');
                    const headers = lines[0].split(',');
                    
                    // Process data...
                    alert('Import successful! (Note: This is a demo - actual import logic would process the CSV data)');
                    closeModal('importModal');
                    renderOrgChart();
                    updateMetrics();
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function resetToBaseline() {
            if (confirm('Reset all changes to baseline? This cannot be undone.')) {
                orgData = JSON.parse(JSON.stringify(scenarios.baseline.data));
                renderOrgChart();
                updateMetrics();
                alert('Reset to baseline complete');
            }
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown.open').forEach(dropdown => {
                    dropdown.classList.remove('open');
                });
            }
        });
        
        // Window resize handler
        window.addEventListener('resize', function() {
            if (currentView === 'orgchart') {
                drawConnections();
            }
        });
    </script>
</body>
</html>